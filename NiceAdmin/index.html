<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Dashboard - Qu·∫£n l√Ω kho h√†ng Smart Zone</title>

  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <link href="assets/css/style.css" rel="stylesheet">

  <style>
    /* --- Custom Card Styles --- */
    .card-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; }
    .card-sales .card-icon { color: #4154f1; background: #f6f9ff; }
    .card-revenue .card-icon { color: #2eca6a; background: #e0f8e9; }
    .card-customers .card-icon { color: #ff771d; background: #ffecdf; }
    .card-products .card-icon { color: #0dcaf0; background: #e0f8f8; } 
    .card-orders .card-icon { color: #712cf9; background: #f3e5f5; } 
    .card-suppliers .card-icon { color: #fd7e14; background: #fff3cd; } 
    .card-expense .card-icon { color: #dc3545; background: #f8d7da; }

    /* Activity Styles */
    .activity-item { font-size: 14px; padding-bottom: 15px; padding-left: 20px; border-left: 2px solid #e0e0e0; position: relative; }
    .activity-item:last-child { border-left: 2px solid transparent; }
    .activity-item::before { content: ""; position: absolute; width: 12px; height: 12px; border-radius: 50%; left: -7px; top: 0px; background: #fff; border: 2px solid #4154f1; }
    .activite-label { min-width: 64px; font-size: 12px; color: #888; display: inline-block; }
    .activity-content { padding-left: 10px; padding-bottom: 0; display: inline-block; }
    .activity-item.text-primary::before { border-color: #0d6efd; }
    .activity-item.text-success::before { border-color: #198754; }
    .activity-item.text-warning::before { border-color: #ffc107; }

    .product-img-thumb { width: 40px; height: 40px; object-fit: cover; border-radius: 5px; }
    #headerAvatar { width: 36px; height: 36px; object-fit: cover; border-radius: 50%; }
    
    /* Dark Mode */
    body.dark-mode { background-color: #1a1a2e; color: #e0e0e0; }
    body.dark-mode .header { background-color: #16213e; box-shadow: 0px 2px 20px rgba(0, 0, 0, 0.4); }
    body.dark-mode .sidebar, body.dark-mode .card, body.dark-mode .modal-content { background-color: #16213e; color: #fff; border-color: #2c3e50; }
    body.dark-mode .list-group-item { background-color: #16213e; color: #fff; border-color: #2c3e50; }
    body.dark-mode .table { color: #e0e0e0; }
    body.dark-mode .text-dark { color: #fff !important; }
    body.dark-mode .search-form { background-color: #16213e; border-color: #555; }
    body.dark-mode .search-form input, body.dark-mode .search-form button { color: #fff; }
    body.dark-mode .dropdown-menu { background-color: #16213e; border: 1px solid #444; }
    body.dark-mode .dropdown-item { color: #e0e0e0; }
    body.dark-mode .dropdown-item:hover { background-color: #0f3460; }
  </style>
</head>

<body>

  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="assets/img/logo.png" alt="">
        <span class="d-none d-lg-block">Smart Zone</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div>

    <div class="search-bar">
      <form class="search-form d-flex align-items-center" onsubmit="event.preventDefault(); searchDashboard();">
        <input type="text" id="searchInput" placeholder="T√¨m ho·∫°t ƒë·ªông, m√£ phi·∫øu..." title="Enter search keyword">
        <button type="button" onclick="searchDashboard()" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item d-block d-lg-none"><a class="nav-link nav-icon search-bar-toggle " href="#"><i class="bi bi-search"></i></a></li>
        <li class="nav-item dropdown">
          <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell"></i>
            <span class="badge bg-primary badge-number" id="notificationBadge">0</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications" id="notificationList">
            <li class="dropdown-header">ƒêang t·∫£i th√¥ng b√°o...</li>
          </ul>
        </li>
        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Profile" class="rounded-circle" id="headerAvatar">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="headerName">Admin</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header"><h6 id="headerFullName">Qu·∫£n tr·ªã vi√™n</h6><span id="headerRole">Qu·∫£n l√Ω kho</span></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="showUserProfile()"><i class="bi bi-person"></i><span>H·ªì s∆° c·ªßa b·∫°n</span></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="openSettingsModal()"><i class="bi bi-gear"></i><span>C√†i ƒë·∫∑t hi·ªÉn th·ªã</span></a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i><span>ƒêƒÉng xu·∫•t</span></a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
      
      <li class="nav-item" id="menu-thongke">
        <a class="nav-link" href="index.html">
          <i class="bi bi-grid"></i><span>Th·ªëng k√™</span>
        </a>
      </li>
      
      <li class="nav-item" id="menu-hanghoa">
        <a class="nav-link collapsed" data-bs-target="#hanghoa-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-box-seam"></i><span>Qu·∫£n l√Ω H√†ng h√≥a</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="hanghoa-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
          <li><a href="dsdanhmuc.html"><i class="bi bi-circle"></i>Danh s√°ch Danh m·ª•c</a></li>
          <li><a href="dssanpham.html"><i class="bi bi-circle"></i>Danh s√°ch S·∫£n ph·∫©m</a></li>
        </ul>
      </li>

      <li class="nav-item" id="menu-kho">
        <a class="nav-link collapsed" data-bs-target="#kho-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-house-door"></i><span>Qu·∫£n l√Ω Kho h√†ng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="kho-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
          <li><a href="dsphieunhap.html"><i class="bi bi-circle"></i>Danh s√°ch Phi·∫øu Nh·∫≠p</a></li>
          <li><a href="dsphieuxuat.html"><i class="bi bi-circle"></i>Danh s√°ch Phi·∫øu Xu·∫•t</a></li>
          <li><a href="tonkho.html"><i class="bi bi-circle"></i>Th·ªëng k√™ T·ªìn kho</a></li>
        </ul>
      </li>

      <li class="nav-item" id="menu-donhang">
        <a class="nav-link collapsed" href="dsdonhang.html">
          <i class="bi bi-cart-check"></i><span>Qu·∫£n l√Ω ƒê∆°n h√†ng</span>
        </a>
      </li>

      <li class="nav-item" id="menu-khachhang">
        <a class="nav-link collapsed" href="dskhachhang.html">
          <i class="bi bi-people"></i><span>Qu·∫£n l√Ω Kh√°ch h√†ng</span>
        </a>
      </li>
      
      <li class="nav-item" id="menu-ncc">
        <a class="nav-link collapsed" href="dsnhacungcap.html">
          <i class="bi bi-truck"></i><span>Qu·∫£n l√Ω Nh√† cung c·∫•p</span>
        </a>
      </li>
      
      <li class="nav-item" id="menu-account">
        <a class="nav-link collapsed" href="dsnguoidung.html">
          <i class="bi bi-person-gear"></i><span id="label-account">Qu·∫£n l√Ω T√†i kho·∫£n</span>
        </a>
      </li>

      <li class="nav-item" id="menu-role">
        <a class="nav-link collapsed" href="dsvaitro.html">
          <i class="bi bi-shield-lock"></i><span>Qu·∫£n l√Ω Vai tr√≤</span>
        </a>
      </li>
    </ul>
  </aside>

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Dashboard</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Trang ch·ªß</a></li>
          <li class="breadcrumb-item active">T·ªïng quan</li>
        </ol>
      </nav>
    </div>

    <div id="welcome-message" class="text-center py-5" style="display: none;">
        <img src="assets/img/logo.png" alt="SmartZone" style="max-height: 150px; margin-bottom: 20px;">
        <h2 class="text-primary fw-bold">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Smart Zone</h2>
        <p class="lead" id="welcome-subtitle">Ch√∫c b·∫°n m·ªôt ng√†y l√†m vi·ªác hi·ªáu qu·∫£!</p>
        <div class="alert alert-info d-inline-block mt-3">
            <i class="bi bi-info-circle me-2"></i>Vui l√≤ng ch·ªçn ch·ª©c nƒÉng t·ª´ menu b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.
        </div>
    </div>

    <section class="section dashboard" id="main-dashboard-content">
      <div class="row">

        <div class="col-lg-8">
          <div class="row">

            <div class="col-xxl-4 col-md-6 finance-card">
              <div class="card info-card card-sales">
                <div class="card-body">
                  <h5 class="card-title">T·ªïng Thu <span>| Xu·∫•t kho</span></h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-currency-dollar"></i></div>
                    <div class="ps-3"><h6 id="totalRevenue">0ƒë</h6><span class="text-muted small pt-2 ps-1">Doanh thu xu·∫•t</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xxl-4 col-md-6 finance-card">
              <div class="card info-card card-expense">
                <div class="card-body">
                  <h5 class="card-title">T·ªïng Chi <span>| Nh·∫≠p kho</span></h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-bag-check"></i></div>
                    <div class="ps-3"><h6 id="totalExpense">0ƒë</h6><span class="text-muted small pt-2 ps-1">Chi ph√≠ nh·∫≠p</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xxl-4 col-md-6 finance-card">
              <div class="card info-card card-revenue">
                <div class="card-body">
                  <h5 class="card-title">L·ª£i Nhu·∫≠n <span>| ∆Ø·ªõc t√≠nh</span></h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-graph-up-arrow"></i></div>
                    <div class="ps-3"><h6 id="totalProfit">0ƒë</h6><span class="text-muted small pt-2 ps-1">L√£i g·ªôp</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xxl-3 col-md-6">
              <div class="card info-card card-orders">
                <div class="card-body">
                  <h5 class="card-title">ƒê∆°n h√†ng</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-cart-check"></i></div>
                    <div class="ps-3"><h6 id="countDonHang">0</h6><span class="text-muted small pt-2 ps-1">ƒê∆°n</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xxl-3 col-md-6">
              <div class="card info-card card-products">
                <div class="card-body">
                  <h5 class="card-title">S·∫£n ph·∫©m</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-box-seam"></i></div>
                    <div class="ps-3"><h6 id="countSanPham">0</h6><span class="text-muted small pt-2 ps-1">M√£ SP</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xxl-3 col-md-6">
              <div class="card info-card card-customers">
                <div class="card-body">
                  <h5 class="card-title">Kh√°ch h√†ng</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-people"></i></div>
                    <div class="ps-3"><h6 id="countKhachHang">0</h6><span class="text-muted small pt-2 ps-1">Kh√°ch</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xxl-3 col-md-6">
              <div class="card info-card card-suppliers">
                <div class="card-body">
                  <h5 class="card-title">ƒê·ªëi t√°c</h5>
                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle"><i class="bi bi-truck"></i></div>
                    <div class="ps-3"><h6 id="countNCC">0</h6><span class="text-muted small pt-2 ps-1">NCC</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 finance-card">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Bi·ªÉu ƒë·ªì T√†i ch√≠nh <span>/7 ng√†y qua (VND)</span></h5>
                  <div id="reportsChart"></div>
                </div>
              </div>
            </div>
            
            <div class="col-12">
              <div class="card top-selling overflow-auto">
                <div class="card-body pb-0">
                  <div class="d-flex justify-content-between align-items-center">
                      <h5 class="card-title text-danger mb-0">‚ö†Ô∏è C·∫£nh b√°o s·∫Øp h·∫øt h√†ng <span>(T·ªìn < 10)</span></h5>
                      <button type="button" class="btn btn-sm btn-primary shadow-sm" onclick="analyzeRestock()">
                        <i class="bi bi-stars me-1"></i> Tr·ª£ l√Ω AI G·ª£i √Ω Nh·∫≠p h√†ng
                      </button>
                  </div>
                  
                  <table class="table table-borderless mt-3">
                    <thead><tr><th scope="col">·∫¢nh</th><th scope="col">S·∫£n ph·∫©m</th><th scope="col" class="text-center">T·ªìn kho</th><th scope="col" class="text-center">Tr·∫°ng th√°i</th></tr></thead>
                    <tbody id="lowStockTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card">
                <div class="card-body pb-0">
                  <h5 class="card-title">üî• S·∫£n ph·∫©m b√°n ch·∫°y <span>| Top 5</span></h5>
                  <div class="table-responsive">
                    <table class="table table-hover">
                        <thead><tr><th>#</th><th>S·∫£n ph·∫©m</th><th>ƒê√£ b√°n</th></tr></thead>
                        <tbody id="topSellingBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <div class="col-lg-4">
          
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y <span>| C·ªßa b·∫°n</span></h5>
                    <div class="activity" id="recentActivityBody" style="max-height: 400px; overflow-y: auto;">
                        <div class="text-center text-muted p-3">ƒêang t·∫£i...</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">T√¨nh tr·∫°ng ƒë∆°n h√†ng</h5>
                    <div id="orderStatusChart" style="min-height: 300px;" class="echart"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body pb-0">
                    <h5 class="card-title">T·ªìn kho theo Danh m·ª•c <span>| % S·ªë l∆∞·ª£ng</span></h5>
                    <div id="categoryStockChart" style="min-height: 300px;" class="echart"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body pb-0">
                    <h5 class="card-title">üíé Top Kh√°ch h√†ng</h5>
                    <table class="table table-borderless table-hover">
                        <thead><tr><th scope="col">Kh√°ch h√†ng</th><th scope="col">Chi ti√™u</th></tr></thead>
                        <tbody id="topCustomerBody"></tbody>
                    </table>
                </div>
            </div>

        </div>
      </div>
    </section>
  </main>

  <div class="modal fade" id="restockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white" style="background: linear-gradient(45deg, #4154f1, #2eca6a);">
          <h5 class="modal-title"><i class="bi bi-robot"></i> Tr·ª£ l√Ω AI G·ª£i √Ω Nh·∫≠p h√†ng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-light border-primary border-start border-4">
              <i class="bi bi-info-circle-fill text-primary"></i> 
              H·ªá th·ªëng ph√°t hi·ªán c√°c s·∫£n ph·∫©m d∆∞·ªõi ƒë·ªãnh m·ª©c an to√†n <strong>(< 10)</strong>. ƒê·ªÅ xu·∫•t nh·∫≠p th√™m ƒë·ªÉ ƒë·∫°t m·ª©c an to√†n <strong>50</strong>.
          </div>
          <table class="table table-hover mt-3">
              <thead class="table-light">
                  <tr>
                      <th>S·∫£n ph·∫©m</th>
                      <th class="text-center text-danger">T·ªìn kho</th>
                      <th class="text-center text-success">ƒê·ªÅ xu·∫•t nh·∫≠p</th>
                      <th class="text-end">ƒê∆°n gi√° d·ª± ki·∫øn</th>
                  </tr>
              </thead>
              <tbody id="restockTableBody"></tbody>
          </table>
          <div class="text-end mt-3">
              <h5>T·ªïng ng√¢n s√°ch d·ª± ki·∫øn: <span id="totalRestockCost" class="text-danger fw-bold">0 ƒë</span></h5>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-success fw-bold" onclick="executeAutoImport()">
              <i class="bi bi-cart-plus-fill"></i> T·∫°o Phi·∫øu Nh·∫≠p Ngay
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="userProfileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">H·ªì s∆° c·ªßa b·∫°n</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><img src="" id="profileAvatar" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover; border: 3px solid #0d6efd;"><h4 id="profileName" class="fw-bold"></h4><p id="profileRole" class="text-muted mb-3"></p><div class="text-start px-3"><p><strong>M√£ TK:</strong> <span id="profileId"></span></p><p><strong>Email:</strong> <span id="profileEmail"></span></p><p><strong>SƒêT:</strong> <span id="profilePhone"></span></p></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button></div></div></div></div>
  <div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-gear-fill me-2"></i>C√†i ƒë·∫∑t hi·ªÉn th·ªã</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-between align-items-center mb-4"><div><h6 class="mb-0 fw-bold">Ch·∫ø ƒë·ªô t·ªëi</h6></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()"></div></div><hr><div class="mb-3"><h6 class="mb-2 fw-bold">K√≠ch th∆∞·ªõc ch·ªØ</h6><input type="range" class="form-range" min="12" max="20" step="1" id="fontSizeRange" oninput="changeFontSize(this.value)"><div class="d-flex justify-content-between small"><span>Nh·ªè</span><span id="fontSizeValue">14px</span><span>L·ªõn</span></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Xong</button></div></div></div></div>

  <footer id="footer" class="footer"><div class="copyright">&copy; SmartZone</div></footer>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/echarts/echarts.min.js"></script>
  <script src="assets/js/main.js"></script>

  <script>
    const BASE_URL = "http://localhost:8080/api";
    const PHOTO_URL = "http://localhost:8080/photos/sanpham/";
    const AVATAR_URL = "http://localhost:8080/photos/taikhoan/";

    let myActivities = [];
    let suggestedProducts = []; // Bi·∫øn l∆∞u danh s√°ch ƒë·ªÅ xu·∫•t nh·∫≠p h√†ng
    
    const currentUserStr = localStorage.getItem("currentUser");
    if (!currentUserStr) window.location.href = "login.html";
    const currentUser = JSON.parse(currentUserStr);
    var userProfileModal = new bootstrap.Modal(document.getElementById('userProfileModal'));
    var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

    document.addEventListener("DOMContentLoaded", function() {
        setupHeader();
        applyRolePermissions();
        applySavedSettings();
    });

    // --- LOGIC TR·ª¢ L√ù AI & CHUY·ªÇN D·ªÆ LI·ªÜU ---
    function analyzeRestock() {
        // L·∫•y d·ªØ li·ªáu t·ªìn kho m·ªõi nh·∫•t
        fetch(`${BASE_URL}/tonkho`)
            .then(r => r.json())
            .then(stockList => {
                suggestedProducts = []; // Reset
                let totalCost = 0;
                const SAFETY_STOCK = 50; 

                // L·ªçc s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng (< 10)
                stockList.forEach(item => {
                    if (item.soLuongTon < 10) {
                        let buyQty = SAFETY_STOCK - item.soLuongTon;
                        // Gi·∫£ ƒë·ªãnh gi√° nh·∫≠p = 70% gi√° b√°n hi·ªán t·∫°i
                        let estPrice = (item.sanPham.giaBan || 0) * 0.7; 
                        
                        suggestedProducts.push({
                            id: item.sanPham.maSanPham,
                            name: item.sanPham.tenSanPham,
                            qty: buyQty,
                            price: estPrice
                        });
                        totalCost += (buyQty * estPrice);
                    }
                });

                if(suggestedProducts.length === 0) {
                    alert("Kho h√†ng ƒëang ·ªïn ƒë·ªãnh, kh√¥ng c√≥ s·∫£n ph·∫©m n√†o c·∫ßn nh·∫≠p g·∫•p!");
                    return;
                }

                // Render b·∫£ng ra Modal
                const tbody = document.getElementById('restockTableBody');
                tbody.innerHTML = suggestedProducts.map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td class="text-center fw-bold text-danger">${50 - p.qty}</td>
                        <td class="text-center fw-bold text-success">+${p.qty}</td>
                        <td class="text-end">${new Intl.NumberFormat('vi-VN').format(p.price)} ƒë</td>
                    </tr>
                `).join('');
                
                document.getElementById('totalRestockCost').innerText = new Intl.NumberFormat('vi-VN').format(totalCost) + ' ƒë';
                
                // Hi·ªán Modal
                new bootstrap.Modal(document.getElementById('restockModal')).show();
            });
    }

    function executeAutoImport() {
        // L∆∞u d·ªØ li·ªáu v√†o LocalStorage ƒë·ªÉ trang kia ƒë·ªçc ƒë∆∞·ª£c
        localStorage.setItem('AUTO_IMPORT_DATA', JSON.stringify(suggestedProducts));
        // Chuy·ªÉn h∆∞·ªõng
        window.location.href = 'dsphieunhap.html'; 
    }

    // --- H√ÄM PH√ÇN QUY·ªÄN CH√çNH X√ÅC ---
    function applyRolePermissions() {
        const roleName = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "";
        
        // DOM Elements
        const menuThongKe = document.getElementById("menu-thongke");
        const menuHangHoa = document.getElementById("menu-hanghoa"); 
        const menuKho = document.getElementById("menu-kho"); 
        const menuDonHang = document.getElementById("menu-donhang");
        const menuKhachHang = document.getElementById("menu-khachhang");
        const menuNCC = document.getElementById("menu-ncc");
        const menuAccount = document.getElementById("menu-account");
        const menuRole = document.getElementById("menu-role");
        const labelAccount = document.getElementById("label-account");

        const dashboardContent = document.getElementById("main-dashboard-content");
        const welcomeMessage = document.getElementById("welcome-message");
        const financeCards = document.querySelectorAll(".finance-card");

        dashboardContent.style.display = "block";
        welcomeMessage.style.display = "none";
        financeCards.forEach(c => c.style.display = "block");

        if (roleName === "Staff" || roleName === "Nh√¢n vi√™n" || roleName === "Kho") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuNCC) menuNCC.style.display = "none";
            if(menuAccount) menuAccount.style.display = "none";
            if(menuRole) menuRole.style.display = "none";
            dashboardContent.style.display = "none";
            welcomeMessage.style.display = "block";
        }
        else if (roleName === "Leader" || roleName === "Tr∆∞·ªüng nh√≥m" || roleName === "Qu·∫£n l√Ω") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuAccount) menuAccount.style.display = "none";
            if(menuRole) menuRole.style.display = "none";
            dashboardContent.style.display = "block";
            financeCards.forEach(c => c.style.display = "none"); 
            loadDashboardData(); 
        }
        else if (roleName === "Boss" || roleName === "Gi√°m ƒë·ªëc") {
            if (menuAccount) {
                if(labelAccount) labelAccount.innerText = "Qu·∫£n l√Ω Nh√¢n s·ª±";
                const icon = menuAccount.querySelector("a i");
                if(icon) { icon.classList.remove("bi-person-gear"); icon.classList.add("bi-people-fill"); }
            }
            if(menuRole) menuRole.style.display = "none";
            dashboardContent.style.display = "block";
            loadDashboardData();
        }
        else if (roleName === "Admin" || roleName === "Qu·∫£n tr·ªã vi√™n") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuHangHoa) menuHangHoa.style.display = "none";
            if(menuKho) menuKho.style.display = "none";
            if(menuDonHang) menuDonHang.style.display = "none";
            if(menuKhachHang) menuKhachHang.style.display = "none";
            if(menuNCC) menuNCC.style.display = "none";
            dashboardContent.style.display = "none";
            welcomeMessage.style.display = "block";
            document.getElementById("welcome-subtitle").innerText = "H·ªá th·ªëng qu·∫£n tr·ªã ng∆∞·ªùi d√πng & ph√¢n quy·ªÅn.";
        }
    }

    function setupHeader() {
        const avatarUrl = currentUser.hinhAnh ? (AVATAR_URL + currentUser.hinhAnh) : "assets/img/profile-img.jpg";
        document.getElementById("headerName").innerText = currentUser.tenDangNhap;
        document.getElementById("headerAvatar").src = avatarUrl;
        document.getElementById("headerFullName").innerText = currentUser.hoVaTen || currentUser.tenDangNhap;
        document.getElementById("headerRole").innerText = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "Nh√¢n vi√™n";
        document.getElementById("profileAvatar").src = avatarUrl;
    }

    function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " nƒÉm tr∆∞·ªõc";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " th√°ng tr∆∞·ªõc";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " ng√†y tr∆∞·ªõc";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc";
        return "V·ª´a xong";
    }

    function formatMoney(amount) {
        if (Math.abs(amount) >= 1000000000) return (amount / 1000000000).toFixed(1) + " T·ª∑";
        if (Math.abs(amount) >= 1000000) return (amount / 1000000).toFixed(1) + " Tr";
        return new Intl.NumberFormat('vi-VN').format(amount) + "ƒë";
    }

    async function loadDashboardData() {
        try {
            const [
                products, categories, accounts, customers, suppliers, orders, imports, exports, stock
            ] = await Promise.all([
                fetch(`${BASE_URL}/sanpham`).then(r => r.json()),
                fetch(`${BASE_URL}/danhmuc`).then(r => r.json()).catch(() => []),
                fetch(`${BASE_URL}/taikhoan`).then(r => r.json()).catch(() => []), 
                fetch(`${BASE_URL}/khachhang`).then(r => r.json()),
                fetch(`${BASE_URL}/nhacungcap`).then(r => r.json()).catch(() => []), 
                fetch(`${BASE_URL}/donhang`).then(r => r.json()),
                fetch(`${BASE_URL}/phieunhap`).then(r => r.json()),
                fetch(`${BASE_URL}/phieuxuat`).then(r => r.json()),
                fetch(`${BASE_URL}/tonkho`).then(r => r.json())
            ]);

            // 1. T√çNH TO√ÅN T√ÄI CH√çNH
            let totalExpense = imports.reduce((sum, item) => sum + (item.tongTien || 0), 0);
            let totalRevenue = exports.reduce((sum, item) => sum + (item.tongTien || 0), 0);

            // T√≠nh l·ª£i nhu·∫≠n
            let productImportCost = {}; 
            imports.forEach(pn => {
                if (pn.chiTietPhieuNhaps) {
                    pn.chiTietPhieuNhaps.forEach(ct => {
                        let id = ct.sanPham.maSanPham;
                        if (!productImportCost[id]) productImportCost[id] = { qty: 0, cost: 0 };
                        productImportCost[id].qty += ct.soLuong;
                        productImportCost[id].cost += (ct.soLuong * ct.donGiaNhap);
                    });
                }
            });

            let totalCOGS = 0;
            exports.forEach(px => {
                if (px.chiTietPhieuXuats) {
                    px.chiTietPhieuXuats.forEach(ct => {
                        let id = ct.sanPham.maSanPham;
                        let importData = productImportCost[id];
                        let avgImportPrice = (importData && importData.qty > 0) ? (importData.cost / importData.qty) : 0;
                        totalCOGS += (ct.soLuong * avgImportPrice);
                    });
                }
            });
            let totalProfit = totalRevenue - totalCOGS;

            document.getElementById('totalRevenue').innerText = formatMoney(totalRevenue);
            document.getElementById('totalExpense').innerText = formatMoney(totalExpense);
            document.getElementById('totalProfit').innerText = formatMoney(totalProfit);

            // 2. S·ªê LI·ªÜU HO·∫†T ƒê·ªòNG
            document.getElementById('countSanPham').innerText = products.length;
            document.getElementById('countDonHang').innerText = orders.length;
            document.getElementById('countKhachHang').innerText = customers.length;
            document.getElementById('countNCC').innerText = suppliers.length;

            // 3. HO·∫†T ƒê·ªòNG
            myActivities = [];
            imports.forEach(item => {
                if ((item.nguoiNhap ? item.nguoiNhap.maTaiKhoan : '') === currentUser.maTaiKhoan) {
                    myActivities.push({ time: new Date(item.ngayNhap), type: 'success', action: 't·∫°o phi·∫øu nh·∫≠p', code: item.maPhieuNhap });
                }
            });
            exports.forEach(item => {
                if ((item.nguoiXuat ? item.nguoiXuat.maTaiKhoan : '') === currentUser.maTaiKhoan) {
                    myActivities.push({ time: new Date(item.ngayXuat), type: 'warning', action: 't·∫°o phi·∫øu xu·∫•t', code: item.maPhieuXuat });
                }
            });
            orders.forEach(item => {
                const userLap = item.nguoiLap ? item.nguoiLap.maTaiKhoan : '';
                if (userLap === currentUser.maTaiKhoan) {
                    myActivities.push({ time: new Date(item.ngayLap), type: 'primary', action: 'l·∫≠p ƒë∆°n h√†ng', code: item.maDonHang });
                }
            });

            myActivities.sort((a, b) => b.time - a.time);
            renderActivities(myActivities);
            renderNotifications(myActivities);

            // 4. BI·ªÇU ƒê·ªí T√ÄI CH√çNH
            const last7Days = [];
            const revenueData = [];
            const expenseData = [];
            
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayStr = d.toISOString().slice(0, 10); 
                const label = d.toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'});
                last7Days.push(label);
                
                const dailyImp = imports.filter(x => x.ngayNhap.startsWith(dayStr)).reduce((sum, item) => sum + (item.tongTien || 0), 0);
                expenseData.push(dailyImp);

                const dailyExp = exports.filter(x => x.ngayXuat.startsWith(dayStr)).reduce((sum, item) => sum + (item.tongTien || 0), 0);
                revenueData.push(dailyExp);
            }

            new ApexCharts(document.querySelector("#reportsChart"), {
                series: [ { name: 'Doanh Thu', data: revenueData }, { name: 'Chi Ph√≠', data: expenseData } ],
                chart: { height: 350, type: 'area', toolbar: { show: false } },
                markers: { size: 4 },
                colors: ['#4154f1', '#ff771d'],
                fill: { type: "gradient", gradient: { shadeIntensity: 1, opacityFrom: 0.3, opacityTo: 0.4, stops: [0, 90, 100] } },
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                xaxis: { categories: last7Days, tooltip: { enabled: false } },
                yaxis: { labels: { formatter: (val) => formatMoney(val) } },
                tooltip: { y: { formatter: (val) => new Intl.NumberFormat('vi-VN').format(val) + 'ƒë' } }
            }).render();

            // 5. Bi·ªÉu ƒë·ªì Tr·∫°ng th√°i ƒê∆°n h√†ng
            const statusCounts = { 'M·ªõi': 0, 'Ch·ªù x·ª≠ l√Ω': 0, 'ƒêang giao': 0, 'Ho√†n th√†nh': 0, 'ƒê√£ h·ªßy': 0 };
            orders.forEach(o => { if(statusCounts[o.trangThai] !== undefined) statusCounts[o.trangThai]++; });
            echarts.init(document.querySelector("#orderStatusChart")).setOption({
                tooltip: { trigger: 'item' },
                legend: { top: '5%', left: 'center' },
                series: [{
                    name: 'Tr·∫°ng th√°i', type: 'pie', radius: ['40%', '70%'], avoidLabelOverlap: false,
                    label: { show: false, position: 'center' },
                    emphasis: { label: { show: true, fontSize: '18', fontWeight: 'bold' } },
                    data: [
                        { value: statusCounts['Ch·ªù x·ª≠ l√Ω'] + statusCounts['M·ªõi'], name: 'M·ªõi/Ch·ªù', itemStyle: { color: '#4154f1' } },
                        { value: statusCounts['ƒêang giao'], name: 'ƒêang giao', itemStyle: { color: '#ff771d' } },
                        { value: statusCounts['Ho√†n th√†nh'], name: 'Ho√†n th√†nh', itemStyle: { color: '#2eca6a' } },
                        { value: statusCounts['ƒê√£ h·ªßy'], name: 'ƒê√£ h·ªßy', itemStyle: { color: '#ff4d4f' } }
                    ]
                }]
            });

            // 6. Top S·∫£n ph·∫©m b√°n ch·∫°y
            let productSales = {};
            orders.filter(o => o.trangThai === 'Ho√†n th√†nh').forEach(o => {
                o.chiTietDonHangs.forEach(ct => {
                    const name = ct.sanPham.tenSanPham;
                    if(!productSales[name]) productSales[name] = 0;
                    productSales[name] += ct.soLuong;
                });
            });
            const topSelling = Object.entries(productSales).sort(([,a], [,b]) => b - a).slice(0, 5);
            document.getElementById('topSellingBody').innerHTML = topSelling.map(([name, qty], index) => `
                <tr><td><span class="rank-badge top-${index+1 <= 3 ? index+1 : 'other'}">${index+1}</span></td><td>${name}</td><td class="fw-bold text-success">${qty}</td></tr>
            `).join('');

            // 7. C·∫£nh b√°o h·∫øt h√†ng
            const lowStock = stock.filter(s => s.soLuongTon < 10).slice(0, 5);
            document.getElementById('lowStockTableBody').innerHTML = lowStock.map(s => `
                <tr>
                    <th scope="row"><img src="${s.sanPham.hinhAnh ? PHOTO_URL + s.sanPham.hinhAnh : 'https://via.placeholder.com/40'}" class="product-img-thumb"></th>
                    <td><a href="#" class="text-primary fw-bold">${s.sanPham.tenSanPham}</a></td>
                    <td class="text-center fw-bold text-${s.soLuongTon === 0 ? 'danger' : 'warning'}">${s.soLuongTon}</td>
                    <td class="text-center"><span class="badge bg-${s.soLuongTon === 0 ? 'danger' : 'warning'}">${s.soLuongTon === 0 ? 'H·∫øt h√†ng' : 'S·∫Øp h·∫øt'}</span></td>
                </tr>
            `).join('');
            
            // 8. Top Kh√°ch h√†ng
            let customerSpending = {};
            orders.filter(o => o.trangThai === 'Ho√†n th√†nh').forEach(o => {
                const name = o.khachHang ? o.khachHang.tenKhachHang : 'Kh√°ch l·∫ª';
                if(!customerSpending[name]) customerSpending[name] = 0;
                customerSpending[name] += o.tongTien;
            });
            const topCustomers = Object.entries(customerSpending).sort(([,a], [,b]) => b - a).slice(0, 5);
            document.getElementById('topCustomerBody').innerHTML = topCustomers.map(([name, total]) => `
                <tr><td>${name}</td><td class="text-primary fw-bold">${formatMoney(total)}</td></tr>
            `).join('');

            // 9. Bi·ªÉu ƒë·ªì T·ªìn kho theo Danh m·ª•c
            let categoryStockCounts = {};
            stock.forEach(s => {
                let catName = (s.sanPham && s.sanPham.danhMuc) ? s.sanPham.danhMuc.tenDanhMuc : "Ch∆∞a ph√¢n lo·∫°i";
                if (!categoryStockCounts[catName]) categoryStockCounts[catName] = 0;
                categoryStockCounts[catName] += s.soLuongTon;
            });
            let pieChartData = Object.keys(categoryStockCounts).map(key => { return { value: categoryStockCounts[key], name: key }; });
            echarts.init(document.querySelector("#categoryStockChart")).setOption({
                tooltip: { trigger: 'item', formatter: '{b}: {c} sp ({d}%)' },
                legend: { top: '5%', left: 'center' },
                series: [{
                    name: 'Danh m·ª•c', type: 'pie', radius: '70%', center: ['50%', '55%'], 
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 0, borderColor: '#fff', borderWidth: 1 },
                    label: { show: false, position: 'center' },
                    emphasis: { label: { show: true, fontSize: '16', fontWeight: 'bold' } },
                    labelLine: { show: false },
                    data: pieChartData
                }]
            });

        } catch (error) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu Dashboard:", error);
        }
    }

    function renderActivities(list) {
        const container = document.getElementById('recentActivityBody');
        if (list.length === 0) { container.innerHTML = '<div class="text-center text-muted p-3">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</div>'; return; }
        container.innerHTML = list.slice(0, 10).map(act => `
            <div class="activity-item d-flex text-${act.type}">
                <div class="activite-label">${timeAgo(act.time)}</div>
                <div class="activity-content">B·∫°n ƒë√£ ${act.action} <a href="#" class="fw-bold text-dark">${act.code}</a></div>
            </div>
        `).join('');
    }

    function renderNotifications(list) {
        const notiList = document.getElementById('notificationList');
        document.getElementById('notificationBadge').innerText = list.length;
        let html = `<li class="dropdown-header">B·∫°n c√≥ ${list.length} th√¥ng b√°o m·ªõi</li>`;
        list.slice(0, 4).forEach(act => {
            let icon = act.type === 'success' ? 'bi-check-circle text-success' : (act.type === 'warning' ? 'bi-exclamation-circle text-warning' : 'bi-info-circle text-primary');
            html += `<li><hr class="dropdown-divider"></li>
            <li class="notification-item d-flex align-items-start p-2">
              <i class="bi ${icon} me-2 fs-4"></i>
              <div><h6 class="mb-0 font-weight-bold">Ho·∫°t ƒë·ªông m·ªõi</h6><p class="mb-0 small">B·∫°n ƒë√£ ${act.action} <strong>${act.code}</strong></p><p class="text-muted small mb-0">${timeAgo(act.time)}</p></div>
            </li>`;
        });
        notiList.innerHTML = html;
    }

    function searchDashboard() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        if (!keyword) { renderActivities(myActivities); return; }
        const filtered = myActivities.filter(a => a.code.toLowerCase().includes(keyword) || a.action.toLowerCase().includes(keyword));
        renderActivities(filtered);
    }

    function showUserProfile() {
        document.getElementById('profileId').innerText = currentUser.maTaiKhoan;
        document.getElementById('profileName').innerText = currentUser.hoVaTen || currentUser.tenDangNhap;
        document.getElementById('profileEmail').innerText = currentUser.email || "Ch∆∞a c·∫≠p nh·∫≠t";
        document.getElementById('profilePhone').innerText = currentUser.sdt || "Ch∆∞a c·∫≠p nh·∫≠t";
        userProfileModal.show();
    }
    function openSettingsModal() {
        document.getElementById("darkModeSwitch").checked = localStorage.getItem("darkMode") === "true";
        document.getElementById("fontSizeRange").value = localStorage.getItem("fontSize") || "14";
        settingsModal.show();
    }
    function toggleDarkMode() {
        const check = document.getElementById("darkModeSwitch").checked;
        if(check) { document.body.classList.add("dark-mode"); localStorage.setItem("darkMode", "true"); } 
        else { document.body.classList.remove("dark-mode"); localStorage.setItem("darkMode", "false"); }
    }
    function changeFontSize(val) {
        document.documentElement.style.fontSize = val + "px"; document.body.style.fontSize = val + "px";
        localStorage.setItem("fontSize", val);
    }
    function applySavedSettings() {
        if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");
        const fs = localStorage.getItem("fontSize");
        if(fs) { document.documentElement.style.fontSize = fs + "px"; document.body.style.fontSize = fs + "px"; }
    }
    function logout() {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) { localStorage.removeItem("currentUser"); window.location.href="login.html"; }
    }
  </script>

</body>
</html>