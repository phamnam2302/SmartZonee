<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Quản lý Danh mục - Smart Zone</title>
  
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i" rel="stylesheet">
  
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
    /* --- CSS CHUNG --- */
    .pagination-info { color: #6c757d; font-size: 0.9rem; }
    .table th { white-space: nowrap; vertical-align: middle; font-weight: 600; }
    .table td { vertical-align: middle; }
    .action-col { white-space: nowrap; width: 100px; text-align: center; }
    
    /* Ảnh Danh mục */
    .category-img { 
        width: 50px; height: 50px; object-fit: cover; 
        border-radius: 8px; border: 1px solid #dee2e6; background: #fff; padding: 2px;
    }
    
    /* Avatar Header */
    #headerAvatar { width: 36px; height: 36px; object-fit: cover; border-radius: 50%; border: 1px solid #e0e0e0; }
    #profileAvatar { object-fit: cover; border: 3px solid #0d6efd; }

    /* Preview ảnh modal */
    #previewContainer { display: none; text-align: center; margin-top: 10px; }
    #previewImg { max-height: 100px; border: 1px solid #ddd; padding: 2px; border-radius: 4px; }

    /* --- SEARCH BAR --- */
    .search-bar { min-width: 360px; padding: 0 20px; }
    .search-form {
        width: 100%; border: 1px solid rgba(1, 41, 112, 0.2); padding: 0px 10px;
        border-radius: 4px; display: flex; align-items: center;
        background-color: #fff; transition: 0.3s;
    }
    .search-form:focus-within { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1); }
    .search-form input {
        border: none !important; outline: none !important; box-shadow: none !important;
        padding: 4px 8px; width: 100%; background: transparent; color: #012970; font-size: 14px;
    }
    .search-form button[title="Search"] { border: 0; background: transparent; color: #012970; margin-left: 8px; }
    #btnClearSearch { border: none; background: transparent; color: #dc3545; font-size: 10px; cursor: pointer; }

    /* --- DARK MODE --- */
    body.dark-mode { background-color: #1a1a2e; color: #e0e0e0; }
    body.dark-mode .header { background-color: #16213e; box-shadow: 0px 2px 20px rgba(0, 0, 0, 0.4); }
    body.dark-mode .sidebar, body.dark-mode .card, body.dark-mode .modal-content { background-color: #16213e; color: #fff; border-color: #2c3e50; }
    body.dark-mode .form-control, body.dark-mode .form-select { background-color: #0f3460; border-color: #2c3e50; color: #fff; }
    body.dark-mode .table { color: #e0e0e0; border-color: #2c3e50; }
    body.dark-mode .table-light th { background-color: #0f3460; color: #fff; border-color: #2c3e50; }
    body.dark-mode .table-hover tbody tr:hover { color: #fff; background-color: #2c3e50; }
    body.dark-mode .search-form { background-color: #16213e; border-color: #555; }
    body.dark-mode .search-form input { color: #fff; }
    body.dark-mode .search-form button { color: #fff; }
    body.dark-mode .nav-link { color: #a5c5ff; }
    body.dark-mode .nav-link.collapsed { color: #e0e0e0; background: transparent; }
    body.dark-mode .dropdown-menu { background-color: #16213e; border: 1px solid #444; }
    body.dark-mode .dropdown-item { color: #e0e0e0; }
    body.dark-mode .dropdown-item:hover { background-color: #0f3460; }
    body.dark-mode .dropdown-header h6 { color: #fff; }
    body.dark-mode .logo span, body.dark-mode .pagetitle h1 { color: #fff; }
  </style>
</head>

<body>

  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="assets/img/logo.png" alt="">
        <span class="d-none d-lg-block">Smart Zone</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div>

    <div class="search-bar">
      <form class="search-form" onsubmit="event.preventDefault(); searchCategories();">
        <input type="text" id="searchInput" placeholder="Tìm Mã hoặc Tên danh mục..." oninput="toggleClearBtn()">
        <button type="button" id="btnClearSearch" class="d-none" onclick="clearSearch()"><i class="bi bi-x-lg"></i></button>
        <button type="button" onclick="searchCategories()" title="Search"><i class="bi bi-search"></i></button>
      </form>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item d-block d-lg-none"><a class="nav-link nav-icon search-bar-toggle " href="#"><i class="bi bi-search"></i></a></li>
        <li class="nav-item dropdown">
          <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-bell"></i><span class="badge bg-primary badge-number">4</span></a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
            <li class="dropdown-header">Bạn có 4 thông báo mới<a href="#"><span class="badge rounded-pill bg-primary p-2 ms-2">Xem tất cả</span></a></li>
          </ul>
        </li>
        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Profile" class="rounded-circle" id="headerAvatar">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="headerName">Admin</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
             <li class="dropdown-header"><h6 id="headerFullName">Quản trị viên</h6><span id="headerRole">Quản lý kho</span></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="showUserProfile()"><i class="bi bi-person"></i><span>Hồ sơ của bạn</span></a></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="openSettingsModal()"><i class="bi bi-gear"></i><span>Cài đặt hiển thị</span></a></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i><span>Đăng xuất</span></a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
      
      <li class="nav-item" id="menu-thongke">
        <a class="nav-link collapsed" href="index.html">
            <i class="bi bi-grid"></i><span>Thống kê</span>
        </a>
      </li>
      
      <li class="nav-item" id="menu-hanghoa">
        <a class="nav-link" data-bs-target="#hanghoa-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-box-seam"></i><span>Quản lý Hàng hóa</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="hanghoa-nav" class="nav-content collapse show" data-bs-parent="#sidebar-nav">
          <li><a href="dsdanhmuc.html" class="active"><i class="bi bi-circle"></i><span>Danh sách Danh mục</span></a></li>
          <li><a href="dssanpham.html"><i class="bi bi-circle"></i><span>Danh sách Sản phẩm</span></a></li>
        </ul>
      </li>

      <li class="nav-item" id="menu-kho">
        <a class="nav-link collapsed" data-bs-target="#kho-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-house-door"></i><span>Quản lý Kho hàng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="kho-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
          <li><a href="dsphieunhap.html"><i class="bi bi-circle"></i><span>Danh sách Phiếu Nhập</span></a></li>
          <li><a href="dsphieuxuat.html"><i class="bi bi-circle"></i><span>Danh sách Phiếu Xuất</span></a></li>
          <li><a href="tonkho.html"><i class="bi bi-circle"></i><span>Thống kê Tồn kho</span></a></li>
        </ul>
      </li>

      <li class="nav-item" id="menu-donhang">
          <a class="nav-link collapsed" href="dsdonhang.html">
              <i class="bi bi-cart-check"></i><span>Quản lý Đơn hàng</span>
          </a>
      </li>

      <li class="nav-item" id="menu-khachhang">
          <a class="nav-link collapsed" href="dskhachhang.html">
              <i class="bi bi-people"></i><span>Quản lý Khách hàng</span>
          </a>
      </li>
      
      <li class="nav-item" id="menu-ncc">
          <a class="nav-link collapsed" href="dsnhacungcap.html">
              <i class="bi bi-truck"></i><span>Quản lý Nhà cung cấp</span>
          </a>
      </li>
      
      <li class="nav-item" id="menu-account">
          <a class="nav-link collapsed" href="dsnguoidung.html">
              <i class="bi bi-person-gear"></i><span id="label-account">Quản lý Tài khoản</span>
          </a>
      </li>

      <li class="nav-item" id="menu-role">
          <a class="nav-link collapsed" href="dsvaitro.html">
              <i class="bi bi-shield-lock"></i><span>Quản lý Vai trò</span>
          </a>
      </li>

    </ul>
  </aside>

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Danh sách Danh mục</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
          <li class="breadcrumb-item">Quản lý Hàng hóa</li>
          <li class="breadcrumb-item active">Danh mục</li>
        </ol>
      </nav>
    </div>

    <section class="section">
      <div class="row">
        <div class="col-lg-12">

          <div class="card">
            <div class="card-body">
              
              <h5 class="card-title d-flex justify-content-between align-items-center">
                Danh sách danh mục
                <button class="btn btn-success btn-sm" onclick="openAddModal()">
                  <i class="bi bi-plus-lg me-1"></i> Thêm Danh mục
                </button>
              </h5>

              <div class="table-responsive">
                  <table class="table table-hover table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th class="text-center">Ảnh</th>
                        <th>Mã DM</th>
                        <th>Tên Danh mục</th>
                        <th class="text-center">Số SP</th>
                        <th>Mô tả</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center action-col">Tác vụ</th>
                      </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                  </table>
              </div>
              
              <div class="d-flex justify-content-between align-items-center mt-4">
                  <div class="pagination-info" id="recordCount"></div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm Danh mục</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="categoryForm">
            <div class="mb-3">
              <label class="form-label">Mã Danh mục <span class="text-danger">*</span></label>
              <input type="text" class="form-control bg-light" id="catId" placeholder="Đang tạo mã..." readonly>
              <div class="form-text text-muted">Mã tự động sinh (DMxxx)</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Tên Danh mục <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="catName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Ảnh đại diện</label>
              <input class="form-control" type="file" id="catImage" accept="image/*" onchange="uploadAnh(this)">
              <input type="hidden" id="hinhAnhDB">
              <div id="previewContainer">
                  <img id="previewImg" src="" alt="Xem trước">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Mô tả</label>
              <textarea class="form-control" id="catDesc" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Trạng thái</label>
              <select class="form-select" id="catStatus">
                  <option value="Hiển thị">Hiển thị</option>
                  <option value="Đang ẩn">Đang ẩn</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="saveCategory()">Lưu lại</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Xác nhận xóa</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn xóa danh mục <strong id="deleteCatId"></strong> này không?<br>Hành động này không thể hoàn tác.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">Xóa ngay</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="userProfileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Hồ sơ của bạn</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><img src="" id="profileAvatar" class="rounded-circle mb-3" style="width: 100px; height: 100px;"><h4 id="profileName" class="fw-bold"></h4><p id="profileRole" class="text-muted mb-3"></p><div class="text-start px-3"><p><strong>Mã TK:</strong> <span id="profileId"></span></p><p><strong>Email:</strong> <span id="profileEmail"></span></p><p><strong>SĐT:</strong> <span id="profilePhone"></span></p><p><strong>Ngày tạo:</strong> <span id="profileDate"></span></p></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div></div></div></div>
  <div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Cài đặt hiển thị</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-between align-items-center mb-4"><div><h6 class="mb-0 fw-bold">Chế độ tối (Dark Mode)</h6><small class="text-muted">Giao diện nền tối bảo vệ mắt</small></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()"></div></div><hr><div class="mb-3"><h6 class="mb-2 fw-bold">Kích thước chữ</h6><input type="range" class="form-range" min="12" max="20" step="1" id="fontSizeRange" oninput="changeFontSize(this.value)"><div class="d-flex justify-content-between small"><span>Nhỏ</span><span id="fontSizeValue">14px</span><span>Lớn</span></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Xong</button></div></div></div></div>

  <footer id="footer" class="footer"><div class="copyright">&copy; SmartZone</div></footer>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>

  <script>
    const BASE_URL = "http://localhost:8080/api";
    const PHOTO_URL = "http://localhost:8080/photos/danhmuc/";
    const AVATAR_URL = "http://localhost:8080/photos/taikhoan/";

    let originalData = []; 
    let productCountMap = {}; 

    const currentUserStr = localStorage.getItem("currentUser");
    if (!currentUserStr) window.location.href = "login.html";
    const currentUser = JSON.parse(currentUserStr);

    document.addEventListener("DOMContentLoaded", function() {
        if(document.getElementById("headerName")) document.getElementById("headerName").innerText = currentUser.tenDangNhap;
        if(document.getElementById("headerFullName")) document.getElementById("headerFullName").innerText = currentUser.hoVaTen || currentUser.tenDangNhap;
        if(document.getElementById("headerRole")) document.getElementById("headerRole").innerText = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "Nhân viên";
        if(document.getElementById("headerAvatar")) document.getElementById("headerAvatar").src = currentUser.hinhAnh ? (AVATAR_URL + currentUser.hinhAnh) : "assets/img/profile-img.jpg";
        
        // GỌI HÀM PHÂN QUYỀN
        applyRolePermissions();

        loadCategories();
        applySavedSettings();
    });

    // --- LOGIC PHÂN QUYỀN MỚI ---
    function applyRolePermissions() {
        const roleName = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "";
        
        // Lấy các phần tử menu theo ID
        const menuThongKe = document.getElementById("menu-thongke");
        const menuHangHoa = document.getElementById("menu-hanghoa"); // Dropdown
        const menuKho = document.getElementById("menu-kho");         // Dropdown
        const menuDonHang = document.getElementById("menu-donhang");
        const menuKhachHang = document.getElementById("menu-khachhang");
        const menuNCC = document.getElementById("menu-ncc");
        const menuAccount = document.getElementById("menu-account");
        const menuRole = document.getElementById("menu-role");
        const labelAccount = document.getElementById("label-account");

        // 1. STAFF: Ẩn Thống kê, NCC, Tài khoản, Vai trò
        if (roleName === "Staff" || roleName === "Nhân viên" || roleName === "Kho") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuNCC) menuNCC.style.display = "none";
            if(menuAccount) menuAccount.style.display = "none";
            if(menuRole) menuRole.style.display = "none";
        }
        
        // 2. LEADER: Ẩn Thống kê, Tài khoản, Vai trò (Hiện NCC)
        else if (roleName === "Leader" || roleName === "Trưởng nhóm" || roleName === "Quản lý") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuAccount) menuAccount.style.display = "none";
            if(menuRole) menuRole.style.display = "none";
        }

        // 3. BOSS: Đổi tên Tài khoản -> Nhân sự, Ẩn Vai trò
        else if (roleName === "Boss" || roleName === "Giám đốc") {
            if (menuAccount) {
                if(labelAccount) labelAccount.innerText = "Quản lý Nhân sự";
                // Đổi icon nếu muốn
                const icon = menuAccount.querySelector("a i");
                if(icon) { icon.classList.remove("bi-person-gear"); icon.classList.add("bi-people-fill"); }
            }
            if(menuRole) menuRole.style.display = "none";
        }

        // 4. ADMIN: CHỈ hiện Tài khoản & Vai trò (Ẩn hết nghiệp vụ bán hàng)
        else if (roleName === "Admin" || roleName === "Quản trị viên") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuHangHoa) menuHangHoa.style.display = "none";
            if(menuKho) menuKho.style.display = "none";
            if(menuDonHang) menuDonHang.style.display = "none";
            if(menuKhachHang) menuKhachHang.style.display = "none";
            if(menuNCC) menuNCC.style.display = "none";
            
            // Hiện 2 cái này
            if(menuAccount) menuAccount.style.display = "block";
            if(menuRole) menuRole.style.display = "block";
        }
    }

    // --- API: LẤY DANH MỤC ---
    async function loadCategories() {
        try {
            const [categories, products] = await Promise.all([
                fetch(`${BASE_URL}/danhmuc`).then(res => res.json()),
                fetch(`${BASE_URL}/sanpham`).then(res => res.json())
            ]);

            productCountMap = {};
            products.forEach(p => {
                if (p.danhMuc && p.danhMuc.maDanhMuc) {
                    const dmId = p.danhMuc.maDanhMuc;
                    productCountMap[dmId] = (productCountMap[dmId] || 0) + 1;
                }
            });

            originalData = categories.sort((a, b) => new Date(b.ngayTao) - new Date(a.ngayTao));
            renderTable(originalData);

        } catch (error) {
            console.error("Lỗi tải dữ liệu:", error);
            document.getElementById("tableBody").innerHTML = '<tr><td colspan="7" class="text-center text-danger">Lỗi kết nối server!</td></tr>';
        }
    }

    function renderTable(list) {
        const tbody = document.getElementById("tableBody");
        let html = "";
        if (list.length === 0) {
            html = '<tr><td colspan="7" class="text-center text-muted">Không tìm thấy dữ liệu</td></tr>';
        } else {
            list.forEach(dm => {
                let imgUrl = dm.hinhAnh ? (PHOTO_URL + dm.hinhAnh) : "https://via.placeholder.com/50x50?text=DM";
                let statusBadge = dm.trangThai === "Hiển thị" ? "bg-success" : "bg-secondary";
                
                let countSP = productCountMap[dm.maDanhMuc] || 0; 
                let dmString = JSON.stringify(dm).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                html += `
                    <tr>
                        <td class="text-center"><img src="${imgUrl}" class="category-img"></td>
                        <td>${dm.maDanhMuc}</td>
                        <td class="fw-bold text-primary">${dm.tenDanhMuc}</td>
                        
                        <td class="text-center">
                            <span class="badge bg-info text-dark rounded-pill" style="font-size: 14px;">
                                ${countSP}
                            </span>
                        </td>

                        <td>${dm.moTa || ''}</td>
                        <td class="text-center"><span class="badge ${statusBadge}">${dm.trangThai}</span></td>
                        <td class="text-center action-col">
                            <button class="btn btn-sm btn-warning" onclick='openEditModal(${dmString})'><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-danger ms-1" onclick="openDeleteModal('${dm.maDanhMuc}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
            });
        }
        tbody.innerHTML = html;
        document.getElementById("recordCount").innerText = `Hiển thị ${list.length} danh mục`;
    }

    function searchCategories() {
        const keyword = document.getElementById("searchInput").value.toLowerCase().trim();
        toggleClearBtn();
        if (!keyword) { renderTable(originalData); return; }
        const filtered = originalData.filter(item => item.tenDanhMuc.toLowerCase().includes(keyword) || item.maDanhMuc.toLowerCase().includes(keyword));
        renderTable(filtered);
    }
    function toggleClearBtn() {
        const val = document.getElementById("searchInput").value;
        const btn = document.getElementById("btnClearSearch");
        if (val.trim().length > 0) btn.classList.remove("d-none"); else btn.classList.add("d-none");
        if (val.length === 0) renderTable(originalData);
    }
    function clearSearch() {
        document.getElementById("searchInput").value = "";
        toggleClearBtn();
        renderTable(originalData);
    }
    var categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    var isEditMode = false;
    var currentDeleteId = null;
    function uploadAnh(input) {
        if (input.files && input.files[0]) {
            var formData = new FormData();
            formData.append("file", input.files[0]);
            fetch(`${BASE_URL}/upload?folder=danhmuc`, { method: 'POST', body: formData }).then(res=>res.json()).then(data=>{
                document.getElementById('previewImg').src = data.url;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('hinhAnhDB').value = data.fileName;
            }).catch(err=>alert("Lỗi upload: "+err));
        }
    }
    function openAddModal() {
        document.getElementById('modalTitle').innerText = "Thêm Danh mục mới";
        document.getElementById('categoryForm').reset();
        document.getElementById('catId').value = "Đang tạo mã...";
        fetch(`${BASE_URL}/danhmuc/next-id`).then(res => res.text()).then(id => document.getElementById('catId').value = id).catch(err => document.getElementById('catId').value = "Lỗi");
        document.getElementById('catId').disabled = true; 
        document.getElementById('previewContainer').style.display = 'none';
        document.getElementById('hinhAnhDB').value = "";
        document.getElementById('catStatus').value = "Hiển thị";
        isEditMode = false;
        categoryModal.show();
    }
    function openEditModal(dm) {
        document.getElementById('modalTitle').innerText = "Cập nhật Danh mục";
        document.getElementById('catId').value = dm.maDanhMuc;
        document.getElementById('catId').disabled = true;
        document.getElementById('catName').value = dm.tenDanhMuc;
        document.getElementById('catDesc').value = dm.moTa || "";
        document.getElementById('catStatus').value = dm.trangThai;
        if(dm.hinhAnh) {
            document.getElementById('previewImg').src = PHOTO_URL + dm.hinhAnh;
            document.getElementById('previewContainer').style.display = 'block';
            document.getElementById('hinhAnhDB').value = dm.hinhAnh;
        } else {
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('hinhAnhDB').value = "";
        }
        isEditMode = true;
        categoryModal.show();
    }
    function saveCategory() {
        const ma = document.getElementById('catId').value.trim();
        const ten = document.getElementById('catName').value.trim();
        if(!ten) { alert("Vui lòng nhập Tên danh mục!"); return; }
        const data = { maDanhMuc: ma, tenDanhMuc: ten, moTa: document.getElementById('catDesc').value.trim(), hinhAnh: document.getElementById('hinhAnhDB').value, trangThai: document.getElementById('catStatus').value };
        const method = isEditMode ? 'PUT' : 'POST';
        const url = isEditMode ? `${BASE_URL}/danhmuc/${ma}` : `${BASE_URL}/danhmuc`;
        fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(async res => { if(!res.ok) throw new Error(await res.text()); return res.json(); }).then(() => { alert("Thành công!"); categoryModal.hide(); loadCategories(); }).catch(err => alert("Lỗi: " + err.message));
    }
    function openDeleteModal(id) { document.getElementById('deleteCatId').innerText = id; currentDeleteId = id; deleteModal.show(); }
    function confirmDelete() { if(!currentDeleteId) return; fetch(`${BASE_URL}/danhmuc/${currentDeleteId}`, { method: 'DELETE' }).then(async res => { if(res.ok) { alert("Xóa thành công!"); deleteModal.hide(); loadCategories(); } else { alert("Không thể xóa!"); } }).catch(err => console.error(err)); }
    var userProfileModal = new bootstrap.Modal(document.getElementById('userProfileModal'));
    var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
    function showUserProfile() {
        document.getElementById('profileId').innerText = currentUser.maTaiKhoan;
        document.getElementById('profileName').innerText = currentUser.hoVaTen || currentUser.tenDangNhap;
        document.getElementById('profileEmail').innerText = currentUser.email || "Chưa cập nhật";
        document.getElementById('profilePhone').innerText = currentUser.sdt || "Chưa cập nhật";
        document.getElementById('profileDate').innerText = currentUser.ngayTao ? currentUser.ngayTao.slice(0, 10) : "N/A";
        document.getElementById('profileRole').innerText = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "Nhân viên";
        document.getElementById('profileAvatar').src = currentUser.hinhAnh ? (PHOTO_URL + currentUser.hinhAnh) : "assets/img/profile-img.jpg";
        userProfileModal.show();
    }
    function openSettingsModal() {
        const isDark = localStorage.getItem("darkMode") === "true";
        document.getElementById("darkModeSwitch").checked = isDark;
        const currentSize = localStorage.getItem("fontSize") || "14";
        document.getElementById("fontSizeRange").value = currentSize;
        document.getElementById("fontSizeValue").innerText = currentSize + "px";
        settingsModal.show();
    }
    function toggleDarkMode() { const isChecked = document.getElementById("darkModeSwitch").checked; if(isChecked) { document.body.classList.add("dark-mode"); localStorage.setItem("darkMode", "true"); } else { document.body.classList.remove("dark-mode"); localStorage.setItem("darkMode", "false"); } }
    function changeFontSize(val) { document.documentElement.style.fontSize = val + "px"; document.body.style.fontSize = val + "px"; document.getElementById("fontSizeValue").innerText = val + "px"; localStorage.setItem("fontSize", val); }
    function applySavedSettings() { if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode"); const savedSize = localStorage.getItem("fontSize"); if(savedSize) document.body.style.fontSize = savedSize + "px"; }
    function logout() { if(confirm("Bạn có chắc chắn muốn đăng xuất?")) { localStorage.removeItem("currentUser"); window.location.href = "login.html"; } }
  </script>

</body>
</html>