<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Quản lý Phiếu Nhập - Smart Zone</title>
  
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
  
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i" rel="stylesheet">
  
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* Đồng bộ Style */
    .search-bar { min-width: 360px; padding: 0 20px; }
    .search-form { width: 100%; }
    .search-form input {
        border: 0; font-size: 14px; color: #012970; border: 1px solid rgba(1, 41, 112, 0.2);
        padding: 7px 38px 7px 8px; border-radius: 3px; transition: 0.3s; width: 100%;
    }
    .search-form input:focus { outline: none; box-shadow: 0 0 10px 0 rgba(1, 41, 112, 0.15); border: 1px solid rgba(1, 41, 112, 0.3); }
    .search-form button { border: 0; padding: 0; margin-left: -30px; background: none; }
    .search-form button i { color: #012970; }

    /* Dark Mode */
    body.dark-mode { background-color: #111; color: #eee; }
    body.dark-mode .card, body.dark-mode .header, body.dark-mode .sidebar, body.dark-mode .modal-content { background-color: #1a1a1a; color: #eee; border-color: #333; }
    body.dark-mode .form-control, body.dark-mode .form-select { background-color: #2a2a2a; border-color: #444; color: #eee; }
    body.dark-mode .table { color: #eee; border-color: #333; }
    body.dark-mode .table-light th { background-color: #2a2a2a; color: #eee; border-color: #333; }
    body.dark-mode .table-hover tbody tr:hover { color: #fff; background-color: #333; }
    body.dark-mode .search-form input { background-color: #2a2a2a; color: #eee; border-color: #444; }
    body.dark-mode .search-form button i { color: #eee; }
    body.dark-mode .bg-light { background-color: #2a2a2a !important; color: #eee; }

    /* Import Table Input Styles */
    .import-table input, .import-table select { border: none; background: transparent; width: 100%; text-align: center; }
    .import-table input:focus, .import-table select:focus { outline: none; background: #fff; border: 1px solid #ced4da; color: #000; }
    .del-row-btn { color: #dc3545; cursor: pointer; font-size: 1.2rem; }
    
    .pagination-info { color: #6c757d; font-size: 0.9rem; }
    .table td { vertical-align: middle; }
    #headerAvatar { width: 36px; height: 36px; object-fit: cover; border-radius: 50%; border: 1px solid #e0e0e0; }
  </style>
</head>

<body>

  <header id="header" class="header fixed-top d-flex align-items-center">
    <div class="d-flex align-items-center justify-content-between">
      <a href="index.html" class="logo d-flex align-items-center">
        <img src="assets/img/logo.png" alt="">
        <span class="d-none d-lg-block">Smart Zone</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div>

    <div class="search-bar">
      <form class="search-form d-flex align-items-center" onsubmit="event.preventDefault(); filterImports();">
        <input type="text" id="searchInput" placeholder="Tìm Mã PN hoặc Tên NCC..." oninput="toggleClearBtn()">
        <button type="button" id="btnClearSearch" class="d-none" onclick="clearSearch()" style="margin-right: 5px;"><i class="bi bi-x-lg"></i></button>
        <button type="button" onclick="filterImports()"><i class="bi bi-search"></i></button>
      </form>
    </div>

    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item d-block d-lg-none"><a class="nav-link nav-icon search-bar-toggle " href="#"><i class="bi bi-search"></i></a></li>
        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="assets/img/profile-img.jpg" alt="Profile" class="rounded-circle" id="headerAvatar">
            <span class="d-none d-md-block dropdown-toggle ps-2" id="headerName">Admin</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
             <li class="dropdown-header"><h6 id="headerFullName">Quản trị viên</h6><span id="headerRole">Quản lý kho</span></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="showUserProfile()"><i class="bi bi-person"></i><span>Hồ sơ của bạn</span></a></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="openSettingsModal()"><i class="bi bi-gear"></i><span>Cài đặt hiển thị</span></a></li>
             <li><hr class="dropdown-divider"></li>
             <li><a class="dropdown-item d-flex align-items-center" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i><span>Đăng xuất</span></a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
      
      <li class="nav-item" id="menu-thongke">
        <a class="nav-link collapsed" href="index.html">
            <i class="bi bi-grid"></i><span>Thống kê</span>
        </a>
      </li>

      <li class="nav-item" id="menu-hanghoa">
        <a class="nav-link collapsed" data-bs-target="#hanghoa-nav" data-bs-toggle="collapse" href="#">
            <i class="bi bi-box-seam"></i><span>Quản lý Hàng hóa</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="hanghoa-nav" class="nav-content collapse" data-bs-parent="#sidebar-nav">
            <li><a href="dsdanhmuc.html"><i class="bi bi-circle"></i>Danh sách Danh mục</a></li>
            <li><a href="dssanpham.html"><i class="bi bi-circle"></i>Danh sách Sản phẩm</a></li>
        </ul>
      </li>
      
      <li class="nav-item" id="menu-kho">
        <a class="nav-link" data-bs-target="#kho-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-house-door"></i><span>Quản lý Kho hàng</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="kho-nav" class="nav-content collapse show" data-bs-parent="#sidebar-nav">
          <li><a href="dsphieunhap.html" class="active"><i class="bi bi-circle"></i><span>Danh sách Phiếu Nhập</span></a></li> 
          <li><a href="dsphieuxuat.html"><i class="bi bi-circle"></i><span>Danh sách Phiếu Xuất</span></a></li>
          <li><a href="tonkho.html"><i class="bi bi-circle"></i><span>Thống kê Tồn kho</span></a></li>
        </ul>
      </li>

      <li class="nav-item" id="menu-donhang">
          <a class="nav-link collapsed" href="dsdonhang.html">
              <i class="bi bi-cart-check"></i><span>Quản lý Đơn hàng</span>
          </a>
      </li>

      <li class="nav-item" id="menu-khachhang">
          <a class="nav-link collapsed" href="dskhachhang.html">
              <i class="bi bi-people"></i><span>Quản lý Khách hàng</span>
          </a>
      </li>
      
      <li class="nav-item" id="menu-ncc">
          <a class="nav-link collapsed" href="dsnhacungcap.html">
              <i class="bi bi-truck"></i><span>Quản lý Nhà cung cấp</span>
          </a>
      </li>
      
      <li class="nav-item" id="menu-account">
          <a class="nav-link collapsed" href="dsnguoidung.html">
              <i class="bi bi-person-gear"></i><span id="label-account">Quản lý Tài khoản</span>
          </a>
      </li>

      <li class="nav-item" id="menu-role">
          <a class="nav-link collapsed" href="dsvaitro.html">
              <i class="bi bi-shield-lock"></i><span>Quản lý Vai trò</span>
          </a>
      </li>

    </ul>
  </aside>

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Danh sách Phiếu Nhập</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
          <li class="breadcrumb-item">Quản lý Kho hàng</li>
          <li class="breadcrumb-item active">Phiếu Nhập</li>
        </ol>
      </nav>
    </div>

    <section class="section">
      <div class="row">
        <div class="col-lg-12">

          <div class="card mb-3">
            <div class="card-body p-3">
                <div class="row g-3 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label fw-bold mb-1 small text-muted">Từ ngày</label>
                    <input type="date" id="startDate" class="form-control">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label fw-bold mb-1 small text-muted">Đến ngày</label>
                    <input type="date" id="endDate" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="filterImports()"><i class="bi bi-funnel"></i> Lọc</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshList()" title="Tải lại toàn bộ"><i class="bi bi-arrow-counterclockwise"></i></button>
                        <button type="button" class="btn btn-success ms-3" onclick="openAddModal()">
                            <i class="bi bi-plus-lg"></i> Tạo Phiếu Nhập
                        </button>
                    </div>
                  </div>
                </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Lịch sử nhập hàng</h5>
              
              <div class="table-responsive">
                  <table class="table table-hover table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th>Mã PN</th>
                        <th>Ngày Nhập</th>
                        <th>Nhà Cung Cấp</th>
                        <th>Người Nhập</th>
                        <th>Tổng Tiền</th>
                        <th>Ghi Chú</th>
                        <th class="text-center">Thao tác</th>
                      </tr>
                    </thead>
                    <tbody id="tableBody">
                      </tbody>
                  </table>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-4">
                  <div class="pagination-info" id="recordCount"></div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Tạo Phiếu Nhập Kho</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="importForm">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label">Mã Phiếu Nhập <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="maPhieuNhap" placeholder="Đang tạo mã..." readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Nhà Cung Cấp</label>
                    <select class="form-select" id="maNCC">
                        <option value="">-- Chọn NCC --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ngày Nhập</label>
                    <input type="datetime-local" class="form-control" id="ngayNhap">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Người Nhập</label>
                    <input type="text" class="form-control bg-light fw-bold" id="tenNguoiNhap" readonly>
                    <input type="hidden" id="maNguoiNhap">
                </div>
                <div class="col-md-12">
                    <label class="form-label">Ghi Chú</label>
                    <textarea class="form-control" id="ghiChu" rows="2" placeholder="Ghi chú..."></textarea>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold text-primary m-0">Chi tiết hàng hóa</h6>
                <button type="button" class="btn btn-sm btn-success" onclick="addProductRow()">
                    <i class="bi bi-plus-circle"></i> Thêm dòng
                </button>
            </div>
            
            <div class="table-responsive border rounded p-2 mb-3" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-bordered mb-0 import-table">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th style="width: 40%;">Sản phẩm</th>
                            <th style="width: 15%;">Số lượng</th>
                            <th style="width: 20%;">Giá nhập (VNĐ)</th>
                            <th style="width: 20%;">Thành tiền</th>
                            <th style="width: 5%;">Xóa</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        </tbody>
                </table>
            </div>

            <div class="row justify-content-end">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text fw-bold">Tổng tiền:</span>
                        <input type="text" class="form-control text-end fw-bold text-danger bg-white" id="tongTien" value="0" readonly>
                        <span class="input-group-text">VNĐ</span>
                    </div>
                </div>
            </div>

          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="saveImport()">Lưu Phiếu Nhập</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Chi tiết Phiếu Nhập <span id="detailCode" class="text-primary fw-bold"></span></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="printSection"><div class="row mb-3 p-3 bg-light border rounded mx-1"><div class="col-md-6 mb-2"><strong>Nhà Cung Cấp:</strong> <span id="detailSupplier"></span></div><div class="col-md-6 mb-2"><strong>Ngày Nhập:</strong> <span id="detailDate"></span></div><div class="col-md-6 mb-2"><strong>Người Nhập:</strong> <span id="detailUser"></span></div><div class="col-md-6 mb-2"><strong>Ghi Chú:</strong> <span id="detailNote" class="text-muted fst-italic"></span></div></div><h6 class="fw-bold border-bottom pb-2">Danh sách hàng nhập</h6><div class="table-responsive"><table class="table table-sm table-striped border"><thead class="table-light"><tr><th>Tên Sản phẩm</th><th class="text-center">SL</th><th class="text-end">Giá nhập</th><th class="text-end">Thành tiền</th></tr></thead><tbody id="detailProductList"></tbody><tfoot><tr><td colspan="3" class="text-end fw-bold pt-3">TỔNG CỘNG:</td><td class="text-end fw-bold text-danger pt-3 fs-5" id="detailTotal">0đ</td></tr></tfoot></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary" onclick="downloadPDF()"><i class="bi bi-printer"></i> In Phiếu</button></div></div></div></div>
  <div class="modal fade" id="deleteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title text-danger">Xác nhận xóa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Bạn có chắc muốn xóa phiếu nhập <strong id="deleteImportId"></strong> không?</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger" onclick="confirmDelete()">Xóa ngay</button></div></div></div></div>
  <div class="modal fade" id="userProfileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Hồ sơ của bạn</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><img src="" id="profileAvatar" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover; border: 3px solid #0d6efd;"><h4 id="profileName" class="fw-bold"></h4><p id="profileRole" class="text-muted mb-3"></p><div class="text-start px-3"><p><strong>Mã TK:</strong> <span id="profileId"></span></p><p><strong>Email:</strong> <span id="profileEmail"></span></p><p><strong>SĐT:</strong> <span id="profilePhone"></span></p></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button></div></div></div></div>
  <div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-gear-fill me-2"></i>Cài đặt hiển thị</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="d-flex justify-content-between align-items-center mb-4"><div><h6 class="mb-0 fw-bold">Chế độ tối</h6></div><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()"></div></div><hr><div class="mb-3"><h6 class="mb-2 fw-bold">Kích thước chữ</h6><input type="range" class="form-range" min="12" max="20" step="1" id="fontSizeRange" oninput="changeFontSize(this.value)"><div class="d-flex justify-content-between small"><span>Nhỏ</span><span id="fontSizeValue">14px</span><span>Lớn</span></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">Xong</button></div></div></div></div>

  <footer id="footer" class="footer"><div class="copyright">&copy; SmartZone</div></footer>
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>

  <script>
    const BASE_URL = "http://localhost:8080/api";
    const PHOTO_URL = "http://localhost:8080/photos/sanpham/";
    const AVATAR_URL = "http://localhost:8080/photos/taikhoan/";

    let originalData = [];
    let suppliers = [];
    let products = [];
    let accounts = []; // Vẫn load để map tên khi hiển thị danh sách

    // Auth
    const currentUserStr = localStorage.getItem("currentUser");
    if (!currentUserStr) window.location.href = "login.html";
    const currentUser = JSON.parse(currentUserStr);

    // Modals
    var importModal = new bootstrap.Modal(document.getElementById('importModal'));
    var detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    var userProfileModal = new bootstrap.Modal(document.getElementById('userProfileModal'));
    var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));

    var isEditMode = false;
    var currentDeleteId = null;

    document.addEventListener("DOMContentLoaded", function() {
        setupHeader();
        applyRolePermissions();
        loadDependencies();
        loadImports();
        applySavedSettings();
    });

    // --- HÀM PHÂN QUYỀN ---
    function applyRolePermissions() {
        const roleName = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "";
        
        const menuThongKe = document.getElementById("menu-thongke");
        const menuHangHoa = document.getElementById("menu-hanghoa");
        const menuKho = document.getElementById("menu-kho");
        const menuDonHang = document.getElementById("menu-donhang");
        const menuKhachHang = document.getElementById("menu-khachhang");
        const menuNCC = document.getElementById("menu-ncc");
        const menuAccount = document.getElementById("menu-account");
        const menuRole = document.getElementById("menu-role");
        const labelAccount = document.getElementById("label-account");

        // 1. STAFF: Ẩn Thống kê, NCC, Tài khoản, Vai trò
        if (roleName === "Staff" || roleName === "Nhân viên" || roleName === "Kho") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuNCC) menuNCC.style.display = "none";
            if(menuAccount) menuAccount.style.display = "none";
            if(menuRole) menuRole.style.display = "none";
        }
        
        // 2. LEADER: Ẩn Thống kê, Tài khoản, Vai trò (Hiện NCC)
        else if (roleName === "Leader" || roleName === "Trưởng nhóm" || roleName === "Quản lý") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuAccount) menuAccount.style.display = "none";
            if(menuRole) menuRole.style.display = "none";
        }

        // 3. BOSS: Đổi tên Tài khoản -> Nhân sự, Ẩn Vai trò
        else if (roleName === "Boss" || roleName === "Giám đốc") {
            if (menuAccount) {
                if(labelAccount) labelAccount.innerText = "Quản lý Nhân sự";
                const icon = menuAccount.querySelector("a i");
                if(icon) { icon.classList.remove("bi-person-gear"); icon.classList.add("bi-people-fill"); }
            }
            if(menuRole) menuRole.style.display = "none";
        }

        // 4. ADMIN: CHỈ hiện Tài khoản & Vai trò
        else if (roleName === "Admin" || roleName === "Quản trị viên") {
            if(menuThongKe) menuThongKe.style.display = "none";
            if(menuHangHoa) menuHangHoa.style.display = "none";
            if(menuKho) menuKho.style.display = "none";
            if(menuDonHang) menuDonHang.style.display = "none";
            if(menuKhachHang) menuKhachHang.style.display = "none";
            if(menuNCC) menuNCC.style.display = "none";
            
            if(menuAccount) menuAccount.style.display = "block";
            if(menuRole) menuRole.style.display = "block";
        }
    }

    function setupHeader() {
        const avatarUrl = currentUser.hinhAnh ? (AVATAR_URL + currentUser.hinhAnh) : "assets/img/profile-img.jpg";
        document.getElementById("headerName").innerText = currentUser.tenDangNhap;
        document.getElementById("headerAvatar").src = avatarUrl;
        document.getElementById("headerFullName").innerText = currentUser.hoVaTen || currentUser.tenDangNhap;
        document.getElementById("headerRole").innerText = currentUser.vaiTro ? currentUser.vaiTro.tenVaiTro : "Nhân viên";
        document.getElementById("profileAvatar").src = avatarUrl;
    }

    function getCurrentDateTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0,16);
    }

    async function loadDependencies() {
        fetch(`${BASE_URL}/nhacungcap`).then(r => r.json()).then(data => {
            suppliers = data;
            const select = document.getElementById("maNCC");
            let html = '<option value="">-- Chọn NCC --</option>';
            data.forEach(ncc => {
                html += `<option value="${ncc.maNCC}">${ncc.tenNCC}</option>`;
            });
            select.innerHTML = html;
        }).catch(err => console.error("Lỗi tải NCC: ", err));

        fetch(`${BASE_URL}/sanpham`).then(r => r.json()).then(data => products = data);

        // Vẫn load tài khoản để hiển thị tên trong danh sách lịch sử
        fetch(`${BASE_URL}/taikhoan`).then(r => r.json()).then(data => accounts = data);
    }

    function loadImports() {
        fetch(`${BASE_URL}/phieunhap`).then(r => r.json()).then(data => {
            originalData = data;
            renderTable(data);
        }).catch(err => console.error(err));
    }

    function renderTable(list) {
        const tbody = document.getElementById("tableBody");
        let html = "";
        if(list.length === 0) html = '<tr><td colspan="7" class="text-center text-muted">Không có dữ liệu</td></tr>';
        else {
            list.forEach(pn => {
                const nccName = pn.ncc ? pn.ncc.tenNCC : 'N/A';
                const userObj = accounts.find(a => a.maTaiKhoan === (pn.nguoiNhap ? pn.nguoiNhap.maTaiKhoan : ''));
                const userName = userObj ? userObj.hoVaTen : (pn.nguoiNhap ? pn.nguoiNhap.maTaiKhoan : 'N/A');
                const total = new Intl.NumberFormat('vi-VN').format(pn.tongTien || 0);
                const dateOnly = new Date(pn.ngayNhap).toLocaleDateString('vi-VN');
                const pnStr = JSON.stringify(pn).replace(/'/g, "&#39;").replace(/"/g, "&quot;");

                html += `
                    <tr>
                        <td><a href="#" onclick='openDetailModal(${pnStr})'>${pn.maPhieuNhap}</a></td>
                        <td>${dateOnly}</td>
                        <td>${nccName}</td>
                        <td>${userName}</td>
                        <td class="fw-bold text-danger">${total}đ</td>
                        <td>${pn.ghiChu || ''}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info" onclick='openDetailModal(${pnStr})'><i class="bi bi-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick='openEditModal(${pnStr})'><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="openDeleteModal('${pn.maPhieuNhap}')"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }
        tbody.innerHTML = html;
        document.getElementById("recordCount").innerText = `Hiển thị ${list.length} phiếu`;
    }

    function filterImports() {
        let keyword = document.getElementById("searchInput").value.toLowerCase().trim();
        let start = document.getElementById("startDate").value;
        let end = document.getElementById("endDate").value;
        toggleClearBtn();

        let filtered = originalData.filter(pn => {
            const nccName = pn.ncc ? pn.ncc.tenNCC.toLowerCase() : '';
            const matchKey = pn.maPhieuNhap.toLowerCase().includes(keyword) || nccName.includes(keyword);
            let matchDate = true;
            if(start && end) {
                const pnDate = pn.ngayNhap.split('T')[0];
                matchDate = pnDate >= start && pnDate <= end;
            }
            return matchKey && matchDate;
        });
        renderTable(filtered);
    }

    function toggleClearBtn() {
        const val = document.getElementById("searchInput").value;
        const btn = document.getElementById("btnClearSearch");
        if(val.trim().length > 0) btn.classList.remove("d-none"); else btn.classList.add("d-none");
    }

    function clearSearch() {
        document.getElementById("searchInput").value = "";
        document.getElementById("searchInput").focus();
        toggleClearBtn();
        filterImports();
    }
    
    function refreshList() {
        document.getElementById("searchInput").value = "";
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        document.getElementById("btnClearSearch").classList.add("d-none");
        loadImports();
    }

    function addProductRow(maSP = '', qty = 1, price = 0) {
        const tbody = document.getElementById('productTableBody');
        const row = document.createElement('tr');
        const total = price * qty;

        let options = `<option value="" data-price="0">-- Chọn SP --</option>`;
        products.forEach(p => {
            const sel = p.maSanPham === maSP ? 'selected' : '';
            options += `<option value="${p.maSanPham}" ${sel}>${p.tenSanPham}</option>`;
        });

        row.innerHTML = `
            <td><select class="form-select border-0" onchange="updateRow(this)">${options}</select></td>
            <td><input type="number" class="form-control border-0 text-center" value="${qty}" min="1" onchange="updateRow(this)" onkeyup="updateRow(this)"></td>
            <td><input type="text" class="form-control border-0 text-end bg-light" value="${price}" onchange="updateRow(this)" onkeyup="updateRow(this)"></td>
            <td><input type="text" class="form-control border-0 text-end fw-bold bg-light row-total" value="${total.toLocaleString('vi-VN')}" readonly data-val="${total}"></td>
            <td class="text-center"><i class="bi bi-trash del-row-btn" onclick="removeRow(this)"></i></td>
        `;
        tbody.appendChild(row);
        calculateTotal();
    }

    function removeRow(btn) { btn.closest('tr').remove(); calculateTotal(); }

    function updateRow(el) {
        const row = el.closest('tr');
        const qty = parseInt(row.querySelectorAll('input')[0].value) || 0;
        const price = parseFloat(row.querySelectorAll('input')[1].value) || 0;
        const total = qty * price;
        const totalInput = row.querySelector('.row-total');
        totalInput.value = total.toLocaleString('vi-VN');
        totalInput.setAttribute('data-val', total);
        calculateTotal();
    }

    function calculateTotal() {
        let sum = 0;
        document.querySelectorAll('.row-total').forEach(inp => sum += parseFloat(inp.getAttribute('data-val')) || 0);
        document.getElementById('tongTien').value = sum.toLocaleString('vi-VN');
    }

    // --- CRUD ---
    function openAddModal() {
        document.getElementById('modalTitle').innerText = "Tạo Phiếu Nhập Kho";
        document.getElementById('importForm').reset();
        fetch(`${BASE_URL}/phieunhap/next-id`).then(r => r.text()).then(id => document.getElementById('maPhieuNhap').value = id);
        
        document.getElementById('maPhieuNhap').disabled = true;
        document.getElementById('ngayNhap').value = getCurrentDateTime();
        
        // GÁN NGƯỜI DÙNG HIỆN TẠI (KHÔNG CHO CHỌN)
        document.getElementById('tenNguoiNhap').value = currentUser.hoVaTen || currentUser.tenDangNhap;
        document.getElementById('maNguoiNhap').value = currentUser.maTaiKhoan;
        
        document.getElementById('productTableBody').innerHTML = '';
        addProductRow();
        calculateTotal();
        isEditMode = false;
        importModal.show();
    }

    function openEditModal(pn) {
        document.getElementById('modalTitle').innerText = "Cập nhật Phiếu Nhập";
        document.getElementById('maPhieuNhap').value = pn.maPhieuNhap;
        document.getElementById('maPhieuNhap').disabled = true;
        document.getElementById('maNCC').value = pn.ncc ? pn.ncc.maNCC : "";
        document.getElementById('ngayNhap').value = pn.ngayNhap.slice(0,16);
        
        // Hiển thị tên người tạo phiếu (có thể khác người đang login)
        const creator = pn.nguoiNhap ? (pn.nguoiNhap.hoVaTen || pn.nguoiNhap.tenDangNhap) : "N/A";
        document.getElementById('tenNguoiNhap').value = creator;
        document.getElementById('maNguoiNhap').value = pn.nguoiNhap ? pn.nguoiNhap.maTaiKhoan : "";
        
        document.getElementById('ghiChu').value = pn.ghiChu || "";

        document.getElementById('productTableBody').innerHTML = '';
        if(pn.chiTietPhieuNhaps) {
            pn.chiTietPhieuNhaps.forEach(ct => {
                addProductRow(ct.sanPham.maSanPham, ct.soLuong, parseFloat(ct.donGiaNhap));
            });
        } else addProductRow();
        
        calculateTotal();
        isEditMode = true;
        importModal.show();
    }

    function saveImport() {
        const maPN = document.getElementById('maPhieuNhap').value;
        const maNCC = document.getElementById('maNCC').value;
        const details = [];
        let count = 1;

        document.querySelectorAll('#productTableBody tr').forEach(row => {
            const maSP = row.querySelector('select').value;
            const qty = parseInt(row.querySelectorAll('input')[0].value);
            const price = parseFloat(row.querySelectorAll('input')[1].value);
            const total = parseFloat(row.querySelector('.row-total').getAttribute('data-val'));

            if(maSP && qty > 0) {
                details.push({
                    maCTPN: maPN + "-" + String(count++).padStart(2,'0'),
                    sanPham: { maSanPham: maSP },
                    soLuong: qty,
                    donGiaNhap: price,
                    thanhTien: total
                });
            }
        });

        if(!maNCC || details.length === 0) { alert("Vui lòng chọn NCC và ít nhất 1 sản phẩm!"); return; }

        const data = {
            maPhieuNhap: maPN,
            ncc: { maNCC: maNCC },
            nguoiNhap: { maTaiKhoan: document.getElementById('maNguoiNhap').value },
            ngayNhap: document.getElementById('ngayNhap').value,
            tongTien: parseFloat(document.getElementById('tongTien').value.replace(/\./g,'')),
            ghiChu: document.getElementById('ghiChu').value,
            chiTietPhieuNhaps: details
        };

        const method = isEditMode ? 'PUT' : 'POST';
        fetch(`${BASE_URL}/phieunhap`, {
            method: method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        }).then(async res => {
            if(!res.ok) throw new Error(await res.text());
            alert("Lưu thành công!"); importModal.hide(); loadImports();
        }).catch(err => alert("Lỗi: " + err.message));
    }

    function openDetailModal(pn) {
        document.getElementById('detailCode').innerText = pn.maPhieuNhap;
        document.getElementById('detailSupplier').innerText = pn.ncc ? pn.ncc.tenNCC : "N/A";
        document.getElementById('detailDate').innerText = new Date(pn.ngayNhap).toLocaleDateString('vi-VN');
        
        const acc = accounts.find(a => a.maTaiKhoan === (pn.nguoiNhap ? pn.nguoiNhap.maTaiKhoan : ''));
        document.getElementById('detailUser').innerText = acc ? acc.hoVaTen : (pn.nguoiNhap ? pn.nguoiNhap.maTaiKhoan : "N/A");
        
        document.getElementById('detailNote').innerText = pn.ghiChu || "";
        
        let html = "";
        let sum = 0;
        if(pn.chiTietPhieuNhaps) {
            pn.chiTietPhieuNhaps.forEach(ct => {
                const total = parseFloat(ct.thanhTien);
                sum += total;
                html += `<tr><td>${ct.sanPham ? ct.sanPham.tenSanPham : ct.maSanPham}</td><td class="text-center">${ct.soLuong}</td><td class="text-end">${parseFloat(ct.donGiaNhap).toLocaleString('vi-VN')}</td><td class="text-end">${total.toLocaleString('vi-VN')}</td></tr>`;
            });
        }
        document.getElementById('detailProductList').innerHTML = html;
        document.getElementById('detailTotal').innerText = sum.toLocaleString('vi-VN') + 'đ';
        detailModal.show();
    }

    function downloadPDF() {
        const element = document.getElementById('printSection');
        const id = document.getElementById('detailCode').innerText;
        html2pdf().set({ margin: 10, filename: `PhieuNhap_${id}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(element).save();
    }

    function openDeleteModal(id) { document.getElementById('deleteImportId').innerText = id; currentDeleteId = id; deleteModal.show(); }
    function confirmDelete() {
        if(!currentDeleteId) return;
        fetch(`${BASE_URL}/phieunhap/${currentDeleteId}`, { method: 'DELETE' }).then(res => {
            if(res.ok) { alert("Xóa thành công!"); deleteModal.hide(); loadImports(); } else alert("Lỗi xóa!");
        });
    }

    function showUserProfile() {
        document.getElementById('profileId').innerText = currentUser.maTaiKhoan;
        document.getElementById('profileName').innerText = currentUser.hoVaTen || currentUser.tenDangNhap;
        document.getElementById('profileEmail').innerText = currentUser.email || "Chưa cập nhật";
        document.getElementById('profilePhone').innerText = currentUser.sdt || "Chưa cập nhật";
        userProfileModal.show();
    }
    function openSettingsModal() {
        document.getElementById("darkModeSwitch").checked = localStorage.getItem("darkMode") === "true";
        document.getElementById("fontSizeRange").value = localStorage.getItem("fontSize") || "14";
        settingsModal.show();
    }
    function toggleDarkMode() {
        const check = document.getElementById("darkModeSwitch").checked;
        if(check) { document.body.classList.add("dark-mode"); localStorage.setItem("darkMode", "true"); }
        else { document.body.classList.remove("dark-mode"); localStorage.setItem("darkMode", "false"); }
    }
    function changeFontSize(val) {
        document.documentElement.style.fontSize = val + "px"; document.body.style.fontSize = val + "px";
        localStorage.setItem("fontSize", val);
    }
    function applySavedSettings() {
        if(localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");
        const fs = localStorage.getItem("fontSize");
        if(fs) { document.documentElement.style.fontSize = fs + "px"; document.body.style.fontSize = fs + "px"; }
    }
    function logout() {
        if(confirm("Đăng xuất?")) { localStorage.removeItem("currentUser"); window.location.href="login.html"; }
    }
  </script>
</body>
</html>